<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <title>JustPos License Generator</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            margin: 0;
            color: #1a1a1a;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 24px;
            color: #2563eb;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #4b5563;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        button {
            width: 100%;
            padding: 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #1d4ed8;
        }

        button:disabled {
            background: #9ca3af;
        }

        /* --- DRAG & DROP ZONE --- */
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.2s;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .drop-zone p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
        }

        .drop-zone strong {
            display: block;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .file-info {
            display: none;
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #15803d;
        }

        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            text-align: center;
        }

        .success {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #86efac;
        }

        .error {
            background: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fca5a5;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>üîë License Generator</h1>

        <div class="form-group">
            <label>1. So'rov faylini tanlang (.hid)</label>

            <div id="dropZone" class="drop-zone">
                <strong>Click to Upload</strong>
                <p>or drag and drop .hid file here</p>
            </div>

            <div id="selectedFileInfo" class="file-info">
                <div>üìÅ <b>Fayl:</b> <span id="fileName">---</span></div>
                <div style="margin-top:4px; color: #4b5563;">üíª <b>HWID:</b> <span id="hwidDisplay">---</span></div>
            </div>
        </div>

        <div class="form-group">
            <label>2. Mijoz Ismi</label>
            <input type="text" id="clientName" placeholder="Restaurant Name">
        </div>

        <div class="form-group">
            <label>3. Litsenziya Turi</label>
            <select id="type" onchange="toggleDays()">
                <option value="lifetime">Lifetime (Umrbod)</option>
                <option value="monthly">Subscription (Oylik)</option>
            </select>
        </div>

        <div class="form-group" id="daysGroup" style="display: none;">
            <label>Necha kun?</label>
            <input type="number" id="days" value="30">
        </div>

        <button id="genBtn" onclick="generate()" disabled>Litsenziya Yaratish</button>

        <div id="result"></div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        let selectedFilePath = null;

        const dropZone = document.getElementById('dropZone');
        const fileInfo = document.getElementById('selectedFileInfo');

        // --- DRAG & DROP EVENTS ---
        dropZone.addEventListener('click', async () => {
            const res = await ipcRenderer.invoke('select-file');
            if (res.success) {
                handleFileSelection(res.path);
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');

            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.path.endsWith('.hid')) {
                    handleFileSelection(file.path);
                } else {
                    alert("Faqat .hid fayl tanlang!");
                }
            }
        });

        async function handleFileSelection(path) {
            selectedFilePath = path;

            // Faylni o'qish va HWID olish
            const res = await ipcRenderer.invoke('read-hid', path);

            if (res.success) {
                fileInfo.style.display = 'block';
                document.getElementById('fileName').innerText = path.split(/[\\/]/).pop();
                document.getElementById('hwidDisplay').innerText = res.data.hwid;

                dropZone.style.display = 'none'; // drop zonani yashirish
                document.getElementById('genBtn').disabled = false;
            } else {
                alert("Faylni o'qishda xatolik. Dastur papkasida JustPOS_*.hid fayllar borligiga ishonch hosil qiling.");
            }
        }

        function toggleDays() {
            const type = document.getElementById('type').value;
            document.getElementById('daysGroup').style.display = type === 'monthly' ? 'block' : 'none';
        }

        async function generate() {
            if (!selectedFilePath) return;
            const clientName = document.getElementById('clientName').value;
            if (!clientName) return alert("Mijoz ismini kiriting!");

            const type = document.getElementById('type').value;
            const days = document.getElementById('days').value;

            document.getElementById('genBtn').disabled = true;
            document.getElementById('genBtn').innerText = "Yaratilmoqda...";

            const res = await ipcRenderer.invoke('generate', {
                hidPath: selectedFilePath,
                clientName,
                type,
                days
            });

            const resultEl = document.getElementById('result');
            resultEl.style.display = 'block';

            if (res.success) {
                resultEl.className = 'success';
                resultEl.innerHTML = `
          <strong>‚úÖ Muvaffaqiyatli!</strong><br>
          Fayl: ${res.filename}<br>
          <span style="font-size: 12px; color: #15803d;">Fayl dastur papkasiga saqlandi.</span>
          <button onclick="location.reload()" style="margin-top:10px; width:auto; padding:5px 10px; font-size:12px;">Yana yaratish üîÑ</button>
        `;
            } else {
                resultEl.className = 'error';
                resultEl.innerText = 'Xatolik: ' + res.error;
            }

            document.getElementById('genBtn').disabled = false;
            document.getElementById('genBtn').innerText = "Litsenziya Yaratish";
        }
    </script>
</body>

</html>